

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#7108B2">
  <meta name="description" content="Perqin&#39;s GitHub pages powered by Hexo.io and hexo-theme-material.">
  <meta name="author" content="Perqin">
  <meta name="keywords" content="">
  
  <title>从Flutter编译错误到给Flutter贡献代码 - Perqin&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/solarized-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"perqin.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#9575CD","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":"1279692316","leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Perqin's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="从Flutter编译错误到给Flutter贡献代码">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-21 13:55" pubdate>
        2021年3月21日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      61
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">从Flutter编译错误到给Flutter贡献代码</h1>
            
            <div class="markdown-body">
              <h1 id="Flutter国际化"><a href="#Flutter国际化" class="headerlink" title="Flutter国际化"></a>Flutter国际化</h1><p><a target="_blank" rel="noopener" href="https://flutter.dev/docs/development/accessibility-and-localization/internationalization">Flutter的官方文档</a>中给出了Flutter应用的国际化和本地化流程。</p>
<p>简而言之，Flutter的国际化依赖代码生成。以JSON格式在指定文件中定义国际化的资源，然后通过Flutter提供的工具动态生成Flutter代码，随后便可以在应用中使用这些代码中的变量。</p>
<p>在根目录（注意<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/issues/75977">不是lib目录下</a>www）下的l10n.yaml中配置本地化配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">arb-dir:</span> <span class="hljs-string">lib/l10n</span><br><span class="hljs-attr">template-arb-file:</span> <span class="hljs-string">app_en.arb</span><br><span class="hljs-attr">output-localization-file:</span> <span class="hljs-string">app_localizations.dart</span><br></code></pre></div></td></tr></table></figure>
<p>然后在lib/l10n中添加各语言的本地化资源文件，其中作为模板的app_en.arb如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;appName&quot;</span>: <span class="hljs-string">&quot;Fandori&quot;</span>,<br>  <span class="hljs-attr">&quot;@appName&quot;</span>: &#123;&#125;,<br>  <span class="hljs-attr">&quot;information&quot;</span>: <span class="hljs-string">&quot;Information&quot;</span>,<br>  <span class="hljs-attr">&quot;@information&quot;</span>: &#123;&#125;,<br>  <span class="hljs-attr">&quot;characters&quot;</span>: <span class="hljs-string">&quot;Characters&quot;</span>,<br>  <span class="hljs-attr">&quot;@characters&quot;</span>: &#123;&#125;,<br>  <span class="hljs-attr">&quot;cards&quot;</span>: <span class="hljs-string">&quot;Cards&quot;</span>,<br>  <span class="hljs-attr">&quot;@cards&quot;</span>: &#123;&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>而其它语言文件就不需要<code>@</code>开头的描述性字段了：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;appName&quot;</span>: <span class="hljs-string">&quot;Fandori&quot;</span>,<br>  <span class="hljs-attr">&quot;information&quot;</span>: <span class="hljs-string">&quot;信息&quot;</span>,<br>  <span class="hljs-attr">&quot;characters&quot;</span>: <span class="hljs-string">&quot;角色&quot;</span>,<br>  <span class="hljs-attr">&quot;cards&quot;</span>: <span class="hljs-string">&quot;卡牌&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在pubspec.yaml中启用本地化：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">dependencies:</span><br>  <span class="hljs-attr">flutter_localizations:</span><br>    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span><br>  <span class="hljs-attr">intl:</span> <span class="hljs-string">^0.16.1</span><br><span class="hljs-attr">flutter:</span><br>  <span class="hljs-attr">generate:</span> <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>
<p>这之后每次运行<code>flutter pub get</code>时，都会触发本地化资源的生成。</p>
<h1 id="JSON序列化"><a href="#JSON序列化" class="headerlink" title="JSON序列化"></a>JSON序列化</h1><p>众所周知，<a target="_blank" rel="noopener" href="https://flutter.dev/docs/development/data-and-backend/json#is-there-a-gsonjacksonmoshi-equivalent-in-flutter">Flutter禁止了反射</a>。因此，JSON序列化也需要使用代码生成来实现。</p>
<p>在pubspec.yaml中添加JSON序列化相关的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">dependencies:</span><br>  <span class="hljs-attr">json_annotation:</span> <span class="hljs-string">^3.1.1</span><br><span class="hljs-attr">dev_dependencies:</span><br>  <span class="hljs-attr">build_runner:</span> <span class="hljs-string">^1.11.1</span><br>  <span class="hljs-attr">json_serializable:</span> <span class="hljs-string">^3.5.1</span><br></code></pre></div></td></tr></table></figure>
<p>然后定义需要支持JSON序列化、反序列化的Model类：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;<br><br><span class="hljs-keyword">part</span> <span class="hljs-string">&#x27;get_band.g.dart&#x27;</span>;<br><br><span class="hljs-meta">@JsonSerializable</span>()<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Band</span> </span>&#123;<br>  <span class="hljs-built_in">int</span> bandId;<br>  <span class="hljs-built_in">String</span> bandName;<br>  <span class="hljs-built_in">String</span> introductions;<br><br>  Band(<br>    <span class="hljs-keyword">this</span>.bandId,<br>    <span class="hljs-keyword">this</span>.bandName,<br>    <span class="hljs-keyword">this</span>.introductions,<br>  );<br><br>  <span class="hljs-keyword">factory</span> Band.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$BandFromJson(json);<br><br>  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() =&gt; _$BandToJson(<span class="hljs-keyword">this</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>对于任意文件<code>some_file.dart</code>中使用<code>JsonSerializable</code>注解标记的类<code>SomeClass</code>，<code>json_serializable</code>会在<code>some_file.g.dart</code>中生成用于序列化的<code>_$SomeClassToJson</code>和用于反序列化的<code>$_SomeClassFromJson</code>方法。</p>
<p>只需要运行<code>flutter pub run build_runner build</code>就可以生成上述<code>.g.dart</code>文件。</p>
<h1 id="build-runner与flutter-generate的冲突"><a href="#build-runner与flutter-generate的冲突" class="headerlink" title="build_runner与flutter_generate的冲突"></a>build_runner与flutter_generate的冲突</h1><p>如果你使用的是1.24以前（不含1.24）的Flutter版本，那么在你运行build_runner的时候，便会遇到这样的错误：</p>
<figure class="highlight gradle"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gradle">Bad state: Unable to generate <span class="hljs-keyword">package</span> graph, no <span class="hljs-regexp">/home/</span>perqin<span class="hljs-regexp">/Workspaces/</span>fandori<span class="hljs-regexp">/.dart_tool/</span>flutter_gen/pubspec.yaml found.<br></code></pre></div></td></tr></table></figure>
<p>完整的错误现场可以看GitHub上<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/issues/75333">另一位老哥发的issue</a>。</p>
<p>这个未被找到的文件位于项目根目录下的<code>.dart_tool/flutter_gen/</code>。查看目录下的文件就会发现，这里面就是Flutter本地化工具生成的代码存放处。</p>
<p>于是我产生了两个疑问：</p>
<ul>
<li>build_runner为什么会检查这个目录下面有没有pubspec.yaml？</li>
<li>Flutter为什么没有在这个目录下生成pubspec.yaml？</li>
</ul>
<h1 id="探索build-runner"><a href="#探索build-runner" class="headerlink" title="探索build_runner"></a>探索build_runner</h1><p>你可以在Flutter安装目录下的.pub-cache\hosted\pub.dartlang.org中找到build_runner的源码（如果你使用了Flutter China的镜像的话，你要在hosted目录下找pub.flutter-io.cn目录）。</p>
<p>顺着错误栈，我们找到了build_runner入口的第一行代码：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// build_runner:build_runner.dart</span><br>Future&lt;<span class="hljs-keyword">void</span>&gt; main(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; args) <span class="hljs-keyword">async</span> &#123;<br>  <span class="hljs-comment">// Use the actual command runner to parse the args and immediately print the</span><br>  <span class="hljs-comment">// usage information if there is no command provided or the help command was</span><br>  <span class="hljs-comment">// explicitly invoked.</span><br>  <span class="hljs-keyword">var</span> commandRunner =<br>      BuildCommandRunner([], <span class="hljs-keyword">await</span> PackageGraph.forThisPackage());<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在进行后续逻辑之前，build_runner会先获取我们项目的包依赖图（Package Graph）。顺着错误栈找下去吧（中文注释是我加上去的）：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// build_runner_core:src/package_graph/package_graph.dart</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PackageGraph</span> </span>&#123;<br>  <span class="hljs-comment">/// <span class="markdown">Creates a [PackageGraph] for the package in which you are currently</span></span><br>  <span class="hljs-comment">/// <span class="markdown">running.</span></span><br>  <span class="hljs-keyword">static</span> Future&lt;PackageGraph&gt; forThisPackage() =&gt;<br>      <span class="hljs-comment">// 读取项目的PackageGraph</span><br>      PackageGraph.forPath(p.current);<br><br>  <span class="hljs-comment">/// <span class="markdown">Creates a [PackageGraph] for the package whose top level directory lives</span></span><br>  <span class="hljs-comment">/// <span class="markdown">at [packagePath] (no trailing slash).</span></span><br>  <span class="hljs-keyword">static</span> Future&lt;PackageGraph&gt; forPath(<span class="hljs-built_in">String</span> packagePath) <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 读取PackageConfig，Flutter会把项目的包依赖信息放在PackageConfig里</span><br>    <span class="hljs-keyword">final</span> packageConfig =<br>        <span class="hljs-keyword">await</span> findPackageConfig(Directory(packagePath), recurse: <span class="hljs-keyword">false</span>);<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 通过PackageConfig解析包依赖</span><br>    <span class="hljs-keyword">final</span> packageDependencies = _parsePackageDependencies(<br>        packageConfig.packages.where((p) =&gt; p.name != rootPackageName));<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">/// <span class="markdown">Read the pubspec for each package in [packages] and finds it&#x27;s</span></span><br><span class="hljs-comment">/// <span class="markdown">dependencies.</span></span><br><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt; _parsePackageDependencies(<br>    <span class="hljs-built_in">Iterable</span>&lt;Package&gt; packages) &#123;<br>  <span class="hljs-keyword">final</span> dependencies = &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt;&#123;&#125;;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> package <span class="hljs-keyword">in</span> packages) &#123;<br>    <span class="hljs-comment">// 针对每个包，读取它的pubspec.yaml</span><br>    <span class="hljs-keyword">final</span> pubspec = _pubspecForPath(package.root.toFilePath());<br>    dependencies[package.name] = _depsFromYaml(pubspec);<br>  &#125;<br>  <span class="hljs-keyword">return</span> dependencies;<br>&#125;<br><br><span class="hljs-comment">/// <span class="markdown">Should point to the top level directory for the package.</span></span><br>YamlMap _pubspecForPath(<span class="hljs-built_in">String</span> absolutePath) &#123;<br>  <span class="hljs-keyword">var</span> pubspecPath = p.join(absolutePath, <span class="hljs-string">&#x27;pubspec.yaml&#x27;</span>);<br>  <span class="hljs-keyword">var</span> pubspec = File(pubspecPath);<br>  <span class="hljs-keyword">if</span> (!pubspec.existsSync()) &#123;<br>    <span class="hljs-comment">// .dart_tool/flutter_gen这个包也被列入了依赖，而这个包里没有pubspec.yaml，所以在这里报了错</span><br>    <span class="hljs-keyword">throw</span> StateError(<br>        <span class="hljs-string">&#x27;Unable to generate package graph, no `<span class="hljs-subst">$pubspecPath</span>` found.&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> loadYaml(pubspec.readAsStringSync()) <span class="hljs-keyword">as</span> YamlMap;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>那么为什么flutter_gen目录会被当作一个包被列入包依赖图的生成呢？package_config这个包中有答案：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// package_config:package_config.dart</span><br>Future&lt;PackageConfig&gt; findPackageConfig(Directory directory,<br>        &#123;<span class="hljs-built_in">bool</span> recurse = <span class="hljs-keyword">true</span>, <span class="hljs-keyword">void</span> onError(<span class="hljs-built_in">Object</span> error)&#125;) =&gt;<br>    discover.findPackageConfig(directory, recurse, onError ?? throwError);<br></code></pre></div></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// package_config:src/discovery.dart</span><br>Future&lt;PackageConfig <span class="hljs-comment">/*?*/</span> &gt; findPackageConfig(<br>    Directory baseDirectory, <span class="hljs-built_in">bool</span> recursive, <span class="hljs-keyword">void</span> onError(<span class="hljs-built_in">Object</span> error)) <span class="hljs-keyword">async</span> &#123;<br>  <span class="hljs-keyword">var</span> directory = baseDirectory;<br>  <span class="hljs-keyword">if</span> (!directory.isAbsolute) directory = directory.absolute;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> directory.exists()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">// Check for $cwd/.packages</span><br>    <span class="hljs-comment">// 读取项目根目录下的.packages信息</span><br>    <span class="hljs-keyword">var</span> packageConfig = <span class="hljs-keyword">await</span> findPackagConfigInDirectory(directory, onError);<br>    <span class="hljs-keyword">if</span> (packageConfig != <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> packageConfig;<br>    <span class="hljs-keyword">if</span> (!recursive) <span class="hljs-keyword">break</span>;<br>    <span class="hljs-comment">// Check in parent directories.</span><br>    <span class="hljs-keyword">var</span> parentDirectory = directory.parent;<br>    <span class="hljs-keyword">if</span> (parentDirectory.path == directory.path) <span class="hljs-keyword">break</span>;<br>    directory = parentDirectory;<br>  &#125; <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>现在我们打开项目根目录下的.packages：</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk"><span class="hljs-comment"># generated by package:package_config at 2021-02-19 10:26:07.001909</span><br><span class="hljs-comment"># 前面省略……</span><br>flutter_gen:.dart_tool<span class="hljs-regexp">/flutter_gen/</span><br></code></pre></div></td></tr></table></figure>
<p>于是我们可以推断出事件的全貌：</p>
<p>Flutter的本地化工具会在.dart_tool目录下生成一个本地的Dart包：flutter_gen，并把生成的本地化代码放入其中。Flutter会把项目的依赖包列表都写入到.packages中，供包括build_runner在内的其他工具使用。</p>
<p>也就是说锅并不是build_runner的，而是Flutter的本地化工具的。</p>
<h1 id="探索Flutter-Localization"><a href="#探索Flutter-Localization" class="headerlink" title="探索Flutter Localization"></a>探索Flutter Localization</h1><p>前面提到，在运行<code>flutter pub get</code>的时候会刷新Flutter本地化代码，这句话的依据在Flutter安装目录下的packages\flutter_tools\lib\src\commands\packages.dart中：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PackagesGetCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FlutterCommand</span> </span>&#123;<br>  Future&lt;<span class="hljs-keyword">void</span>&gt; _runPubGet(<span class="hljs-built_in">String</span> directory, FlutterProject flutterProject) <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-keyword">if</span> (flutterProject.manifest.generateSyntheticPackage) &#123;<br>      <span class="hljs-keyword">final</span> Environment environment = Environment(<br>        artifacts: globals.artifacts,<br>        logger: globals.logger,<br>        cacheDir: globals.cache.getRoot(),<br>        engineVersion: globals.flutterVersion.engineRevision,<br>        fileSystem: globals.fs,<br>        flutterRootDir: globals.fs.directory(Cache.flutterRoot),<br>        outputDir: globals.fs.directory(getBuildDirectory()),<br>        processManager: globals.processManager,<br>        projectDir: flutterProject.directory,<br>      );<br><br>      <span class="hljs-keyword">await</span> generateLocalizationsSyntheticPackage(<br>        environment: environment,<br>        buildSystem: globals.buildSystem,<br>      );<br>      <span class="hljs-comment">// ...</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>那么我是怎么找到这个文件的呢www</p>
<p>在pubspec.yaml中，有这样一个配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">flutter:</span><br>  <span class="hljs-attr">uses-material-design:</span> <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>
<p>在Flutter的GitHub仓库中搜索“uses-material-design”，过滤出Dart文件，很容易就能找到文件packages/flutter_tools/lib/src/flutter_manifest.dart，其中就包含了判断本地化是否启用的代码：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterManifest</span> </span>&#123;<br>  <span class="hljs-comment">/// <span class="markdown">Whether a synthetic flutter<span class="hljs-emphasis">_gen package should be generated.</span></span></span><br>  <span class="hljs-comment">///</span><br>  <span class="hljs-comment">/// <span class="markdown">This can be provided to the [Pub] interface to inject a new entry</span></span><br>  <span class="hljs-comment">/// <span class="markdown">into the package<span class="hljs-emphasis">_config.json file which points to `.dart_</span>tool/flutter<span class="hljs-emphasis">_gen`.</span></span></span><br>  <span class="hljs-comment">///</span><br>  <span class="hljs-comment">/// <span class="markdown">This allows generated source code to be imported using a package</span></span><br>  <span class="hljs-comment">/// <span class="markdown">alias.</span></span><br>  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> generateSyntheticPackage =&gt; _generateSyntheticPackage ??= _computeGenerateSyntheticPackage();<br>  <span class="hljs-built_in">bool</span> _generateSyntheticPackage;<br>  <span class="hljs-built_in">bool</span> _computeGenerateSyntheticPackage() &#123;<br>    <span class="hljs-keyword">if</span> (!_flutterDescriptor.containsKey(<span class="hljs-string">&#x27;generate&#x27;</span>)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Object</span> value = _flutterDescriptor[<span class="hljs-string">&#x27;generate&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">is</span>! <span class="hljs-built_in">bool</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">as</span> <span class="hljs-built_in">bool</span>;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>再顺着generateSyntheticPackage就能找到本地化工具的具体实现了。</p>
<p>回到generateLocalizationsSyntheticPackage：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// packages/flutter_tools/lib/src/dart/generate_synthetic_packages.dart</span><br>Future&lt;<span class="hljs-keyword">void</span>&gt; generateLocalizationsSyntheticPackage(&#123;<br>  <span class="hljs-meta">@required</span> Environment environment,<br>  <span class="hljs-meta">@required</span> BuildSystem buildSystem,<br>&#125;) <span class="hljs-keyword">async</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">final</span> BuildResult result = <span class="hljs-keyword">await</span> buildSystem.build(<br>    <span class="hljs-keyword">const</span> GenerateLocalizationsTarget(),<br>    environment,<br>  );<br><br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span> || result.hasException) &#123;<br>    throwToolExit(<span class="hljs-string">&#x27;Generating synthetic localizations package has failed.&#x27;</span>);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>显然，生成flutter_gen的逻辑就在GenerateLocalizationsTarget了：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// packages/flutter_tools/lib/src/build_system/targets/localizations.dart</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenerateLocalizationsTarget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Target</span> </span>&#123;<br>  <span class="hljs-meta">@override</span><br>  Future&lt;<span class="hljs-keyword">void</span>&gt; build(Environment environment) <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    generateLocalizations(<br>      logger: environment.logger,<br>      options: options,<br>      projectDir: environment.projectDir,<br>      dependenciesDir: environment.buildDir,<br>      localizationsGenerator: LocalizationsGenerator(environment.fileSystem),<br>    );<br>    <span class="hljs-comment">// ...</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// packages/flutter_tools/lib/src/localizations/gen_l10n.dart</span><br><span class="hljs-comment">/// <span class="markdown">Run the localizations generation script with the configuration [options].</span></span><br><span class="hljs-keyword">void</span> generateLocalizations(&#123;<br>  <span class="hljs-meta">@required</span> Directory projectDir,<br>  <span class="hljs-meta">@required</span> Directory dependenciesDir,<br>  <span class="hljs-meta">@required</span> LocalizationOptions options,<br>  <span class="hljs-meta">@required</span> LocalizationsGenerator localizationsGenerator,<br>  <span class="hljs-meta">@required</span> Logger logger,<br>&#125;) &#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    localizationsGenerator<br>      ..initialize(<br>        inputsAndOutputsListPath: dependenciesDir?.path,<br>        projectPathString: projectDir.path,<br>        inputPathString: inputPathString,<br>        templateArbFileName: templateArbFileName,<br>        outputFileString: outputFileString,<br>        outputPathString: options?.outputDirectory?.path,<br>        classNameString: options.outputClass ?? <span class="hljs-string">&#x27;AppLocalizations&#x27;</span>,<br>        preferredSupportedLocales: options.preferredSupportedLocales,<br>        headerString: options.header,<br>        headerFile: options?.headerFile?.toFilePath(),<br>        useDeferredLoading: options.deferredLoading ?? <span class="hljs-keyword">false</span>,<br>        useSyntheticPackage: options.useSyntheticPackage ?? <span class="hljs-keyword">true</span>,<br>        areResourceAttributesRequired: options.areResourceAttributesRequired ?? <span class="hljs-keyword">false</span>,<br>        untranslatedMessagesFile: options?.untranslatedMessagesFile?.toFilePath(),<br>      )<br>      ..loadResources()<br>      ..writeOutputFiles(logger, isFromYaml: <span class="hljs-keyword">true</span>);<br>  &#125; <span class="hljs-keyword">on</span> L10nException <span class="hljs-keyword">catch</span> (e) &#123;<br>    logger.printError(e.message);<br>    <span class="hljs-keyword">throw</span> Exception();<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalizationsGenerator</span> </span>&#123;<br>  <span class="hljs-keyword">void</span> writeOutputFiles(Logger logger, &#123; <span class="hljs-built_in">bool</span> isFromYaml = <span class="hljs-keyword">false</span> &#125;) &#123;<br>    <span class="hljs-comment">// First, generate the string contents of all necessary files.</span><br>    _generateCode();<br><br>    <span class="hljs-comment">// A pubspec.yaml file is required when using a synthetic package. If it does not</span><br>    <span class="hljs-comment">// exist, create a blank one.</span><br>    <span class="hljs-keyword">if</span> (_useSyntheticPackage) &#123;<br>      <span class="hljs-keyword">final</span> Directory syntheticPackageDirectory = _fs.directory(defaultSyntheticPackagePath);<br>      syntheticPackageDirectory.createSync(recursive: <span class="hljs-keyword">true</span>);<br>      <span class="hljs-keyword">final</span> File flutterGenPubspec = syntheticPackageDirectory.childFile(<span class="hljs-string">&#x27;pubspec.yaml&#x27;</span>);<br>      <span class="hljs-keyword">if</span> (!flutterGenPubspec.existsSync()) &#123;<br>        flutterGenPubspec.writeAsStringSync(emptyPubspecTemplate);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>当时我是在GitHub上看这段代码的，很明显在writeOutputFiles中是包含了pubspec.yaml的生成逻辑的，怎么还会找不到呢？</p>
<p>我们切换到v1.22.6这个tag，再看<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/blob/9b2d32b605630f28625709ebd9d78ab3016b2bf6/packages/flutter_tools/lib/src/localizations/gen_l10n.dart#L1003">这个文件</a>：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">void</span> writeOutputFiles() &#123;<br>    <span class="hljs-comment">// First, generate the string contents of all necessary files.</span><br>    _generateCode();<br><br>    <span class="hljs-comment">// Since all validity checks have passed up to this point,</span><br>    <span class="hljs-comment">// write the contents into the directory.</span><br>    <span class="hljs-keyword">if</span> (!outputDirectory.existsSync()) &#123;<br>      outputDirectory.createSync(recursive: <span class="hljs-keyword">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// Ensure that the created directory has read/write permissions.</span><br>    <span class="hljs-keyword">final</span> FileStat fileStat = outputDirectory.statSync();<br>    <span class="hljs-keyword">if</span> (_isNotReadable(fileStat) || _isNotWritable(fileStat)) &#123;<br>      <span class="hljs-keyword">throw</span> L10nException(<br>        <span class="hljs-string">&quot;The &#x27;output-dir&#x27; directory, <span class="hljs-subst">$outputDirectory</span>, doesn&#x27;t allow reading and writing.\n&quot;</span><br>        <span class="hljs-string">&#x27;Please ensure that the user has read and write permissions.&#x27;</span><br>      );<br>    &#125;<br><br>    <span class="hljs-comment">// Generate the required files for localizations.</span><br>    _languageFileMap.forEach((File file, <span class="hljs-built_in">String</span> contents) &#123;<br>      file.writeAsStringSync(contents);<br>      <span class="hljs-keyword">if</span> (_inputsAndOutputsListFile != <span class="hljs-keyword">null</span>) &#123;<br>        _outputFileList.add(file.absolute.path);<br>      &#125;<br>    &#125;);<br><br>    baseOutputFile.writeAsStringSync(_generatedLocalizationsFile);<br>    <span class="hljs-keyword">if</span> (_inputsAndOutputsListFile != <span class="hljs-keyword">null</span>) &#123;<br>      _outputFileList.add(baseOutputFile.absolute.path);<br><br>      <span class="hljs-comment">// Generate a JSON file containing the inputs and outputs of the gen_l10n script.</span><br>      <span class="hljs-keyword">if</span> (!_inputsAndOutputsListFile.existsSync()) &#123;<br>        _inputsAndOutputsListFile.createSync(recursive: <span class="hljs-keyword">true</span>);<br>      &#125;<br><br>      _inputsAndOutputsListFile.writeAsStringSync(<br>        json.encode(&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; &#123;<br>          <span class="hljs-string">&#x27;inputs&#x27;</span>: _inputFileList,<br>          <span class="hljs-string">&#x27;outputs&#x27;</span>: _outputFileList,<br>        &#125;),<br>      );<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br></code></pre></div></td></tr></table></figure>
<p>可见在此刻的最新版本（此时1.23以及更新的版本都还没有进入stable）上还有这个bug，而最新的master代码已经修复了。我们很容易找到<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/pull/68206">对应的PR</a>，查看这个文件的改动对应的<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter/commit/38ebc5588b3d80b5bcce1a0a8114f96813de593f">commit</a>可以看到我们最早也要在1.24中才能收到这个修复了：</p>
<p><img src="flutter-gen-bugfix-commit.png" srcset="/img/loading.gif" lazyload></p>
<p>如果你不想等待1.24发布正式版，你也可以：</p>
<ul>
<li>手动创建pubspec.yaml文件</li>
<li>切换到beta channel</li>
</ul>
<h1 id="Flutter-Localization中的另一个bug"><a href="#Flutter-Localization中的另一个bug" class="headerlink" title="Flutter Localization中的另一个bug"></a>Flutter Localization中的另一个bug</h1><p>在阅读代码的过程中，我留意到GenerateLocalizationsTarget中的代码有些不对劲：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// packages/flutter_tools/lib/src/dart/generate_synthetic_packages.dart</span><br>Future&lt;<span class="hljs-keyword">void</span>&gt; generateLocalizationsSyntheticPackage(&#123;<br>  <span class="hljs-meta">@required</span> Environment environment,<br>  <span class="hljs-meta">@required</span> BuildSystem buildSystem,<br>&#125;) <span class="hljs-keyword">async</span> &#123;<br>  <span class="hljs-keyword">assert</span>(environment != <span class="hljs-keyword">null</span>);<br>  <span class="hljs-keyword">assert</span>(buildSystem != <span class="hljs-keyword">null</span>);<br><br>  <span class="hljs-keyword">final</span> FileSystem fileSystem = environment.fileSystem;<br>  <span class="hljs-keyword">final</span> File l10nYamlFile = fileSystem.file(<br>    fileSystem.path.join(environment.projectDir.path, <span class="hljs-string">&#x27;l10n.yaml&#x27;</span>));<br><br>  <span class="hljs-comment">// If pubspec.yaml has generate:true and if l10n.yaml exists in the</span><br>  <span class="hljs-comment">// root project directory, check to see if a synthetic package should</span><br>  <span class="hljs-comment">// be generated for gen_l10n.</span><br>  <span class="hljs-keyword">if</span> (!l10nYamlFile.existsSync()) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">final</span> YamlNode yamlNode = loadYamlNode(l10nYamlFile.readAsStringSync());<br>  <span class="hljs-keyword">if</span> (yamlNode.value != <span class="hljs-keyword">null</span> &amp;&amp; yamlNode <span class="hljs-keyword">is</span>! YamlMap) &#123;<br>    throwToolExit(<br>      <span class="hljs-string">&#x27;Expected <span class="hljs-subst">$&#123;l10nYamlFile.path&#125;</span> to contain a map, instead was <span class="hljs-subst">$yamlNode</span>&#x27;</span><br>    );<br>  &#125;<br><br>  BuildResult result;<br>  <span class="hljs-comment">// If an l10n.yaml file exists but is empty, attempt to build synthetic</span><br>  <span class="hljs-comment">// package with default settings.</span><br>  <span class="hljs-keyword">if</span> (yamlNode.value == <span class="hljs-keyword">null</span>) &#123;<br>    result = <span class="hljs-keyword">await</span> buildSystem.build(<br>      <span class="hljs-keyword">const</span> GenerateLocalizationsTarget(),<br>      environment,<br>    );<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">final</span> YamlMap yamlMap = yamlNode <span class="hljs-keyword">as</span> YamlMap;<br>    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Object</span> value = yamlMap[<span class="hljs-string">&#x27;synthetic-package&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">is</span>! <span class="hljs-built_in">bool</span> &amp;&amp; value != <span class="hljs-keyword">null</span>) &#123;<br>      throwToolExit(<br>        <span class="hljs-string">&#x27;Expected &quot;synthetic-package&quot; to have a bool value, &#x27;</span><br>        <span class="hljs-string">&#x27;instead was &quot;<span class="hljs-subst">$value</span>&quot;&#x27;</span><br>      );<br>    &#125;<br><br>    <span class="hljs-comment">// Generate gen_l10n synthetic package only if synthetic-package: true or</span><br>    <span class="hljs-comment">// synthetic-package is null.</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isSyntheticL10nPackage = value <span class="hljs-keyword">as</span> <span class="hljs-built_in">bool</span> ?? <span class="hljs-keyword">true</span>;<br>    <span class="hljs-keyword">if</span> (!isSyntheticL10nPackage) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br><br>  result = <span class="hljs-keyword">await</span> buildSystem.build(<br>    <span class="hljs-keyword">const</span> GenerateLocalizationsTarget(),<br>    environment,<br>  );<br><br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span> || result.hasException) &#123;<br>    throwToolExit(<span class="hljs-string">&#x27;Generating synthetic localizations package has failed.&#x27;</span>);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以看到上述代码片段中的31、53行都调用了buildSystem.build，这不是重复调用了？？</p>
<p>为了确认这个问题，首先我将本地Flutter安装目录下的bin/cache/flutter_tools.snapshot删掉，这个文件是Flutter在运行的时候将flutter_tools这个包预先编译成的二进制文件，从而避免每次运行都需要解释执行Dart源码。因此，在修改本地代码之前，需要删掉相应的snapshot文件。</p>
<p>在generate_synthetic_packages.dart文件中的两个build调用前都加上print日志打印，然后观察这段代码，可以看出当<code>(yamlNode.value == null || yamlNode is YamlMap) &amp;&amp; yamlNode.value == null</code>，也就是yamlNode.value为null的时候能够触发。</p>
<p>在l10n.yaml中为空字符串或者null的时候，yamlNode.value为null，而进一步确认packages/flutter_tools/lib/src/localizations/localizations_utils.dart：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart">LocalizationOptions parseLocalizationsOptions(&#123;<br>  <span class="hljs-meta">@required</span> File file,<br>  <span class="hljs-meta">@required</span> Logger logger,<br>&#125;) &#123;<br>  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> contents = file.readAsStringSync();<br>  <span class="hljs-keyword">if</span> (contents.trim().isEmpty) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> LocalizationOptions();<br>  &#125;<br>  <span class="hljs-keyword">final</span> YamlNode yamlNode = loadYamlNode(file.readAsStringSync());<br>  <span class="hljs-keyword">if</span> (yamlNode <span class="hljs-keyword">is</span>! YamlMap) &#123;<br>    logger.printError(<span class="hljs-string">&#x27;Expected <span class="hljs-subst">$&#123;file.path&#125;</span> to contain a map, instead was <span class="hljs-subst">$yamlNode</span>&#x27;</span>);<br>    <span class="hljs-keyword">throw</span> Exception();<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可见如果l10n.yaml包含注释或者null等内容，则会抛出异常，从而在第一次build调用中就会中止。</p>
<p>因此我们打开l10n.yaml，清空其中的内容，然后运行<code>flutter pub get</code>，你就会看到两次build调用的日志打印了。由于这篇文章是拖延了两个月后才写的，当时的现场我懒得复原了www</p>
<p>事实上，只要GenerateLocalizationsTarget的实现是稳定的，那么不论重复运行多少次，应该都能生成一样的本地化相关代码，这个bug并不算严重，但是<del>为了环保</del>我还是尝试了修复。</p>
<p>修复办法平平无奇，这里就不贴了。</p>
<h1 id="将bug掩藏起来的错误的单元测试"><a href="#将bug掩藏起来的错误的单元测试" class="headerlink" title="将bug掩藏起来的错误的单元测试"></a>将bug掩藏起来的错误的单元测试</h1><p>Flutter这样大型的开源项目必然会使用单元测试高强度覆盖，以保证代码质量。上面这个bug涉及的代码也是有单元测试的，那么为什么单元测试没有测出这个问题呢？</p>
<p>上述文件对应的测试代码在packages/flutter_tools/test/general.shard/dart/generate_synthetic_packages_test.dart，可以看到第一个测试用例就是l10n.yaml为空的场景：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  testWithoutContext(<span class="hljs-string">&#x27;calls buildSystem.build with blank l10n.yaml file&#x27;</span>, () &#123;<br>    <span class="hljs-comment">// ...</span><br>    expect(<br>      () =&gt; generateLocalizationsSyntheticPackage(<br>        environment: environment,<br>        buildSystem: buildSystem,<br>      ),<br>      throwsToolExit(message: <span class="hljs-string">&#x27;Generating synthetic localizations package has failed.&#x27;</span>),<br>    );<br>    <span class="hljs-comment">// [BuildSystem] should have called build with [GenerateLocalizationsTarget].</span><br>    verify(buildSystem.build(<br>      <span class="hljs-keyword">const</span> GenerateLocalizationsTarget(),<br>      environment,<br>    )).called(<span class="hljs-number">1</span>);<br>  &#125;);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>我本地运行这个用例，发现这个用例居然是可以通过的！</p>
<p>百思不得其解之际，我在verify处和build调用处都打了断点，意外发现调用顺序如下：</p>
<ol>
<li>第一次build调用</li>
<li>verify</li>
<li>第二次build调用</li>
</ol>
<p>这就奇怪了，第二次build调用还没开始的时候，generateLocalizationsSyntheticPackage还没有执行完毕，怎么就走到verify了呢？</p>
<p>我随便点开了<code>throwsToolExit</code>的实现，发现<code>throwsToolExit</code>实际上返回的是<code>throwsA</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-comment">// packages/flutter_tools/test/src/common.dart</span><br><span class="hljs-comment">/// <span class="markdown">Matcher for functions that throw [ToolExit].</span></span><br>Matcher throwsToolExit(&#123; <span class="hljs-built_in">int</span> exitCode, <span class="hljs-built_in">Pattern</span> message &#125;) &#123;<br>  Matcher matcher = isToolExit;<br>  <span class="hljs-keyword">if</span> (exitCode != <span class="hljs-keyword">null</span>) &#123;<br>    matcher = allOf(matcher, (ToolExit e) =&gt; e.exitCode == exitCode);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (message != <span class="hljs-keyword">null</span>) &#123;<br>    matcher = allOf(matcher, (ToolExit e) =&gt; e.message?.contains(message) ?? <span class="hljs-keyword">false</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> throwsA(matcher);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>然后打开Flutter的官方文档：</p>
<blockquote>
<h1 id="throwsA-function"><a href="#throwsA-function" class="headerlink" title="throwsA function"></a>throwsA function</h1><p>This can be used to match three kinds of objects:</p>
<ul>
<li>A <a target="_blank" rel="noopener" href="https://api.flutter.dev/flutter/dart-core/Function-class.html">Function</a> that throws an exception when called. The function cannot take any arguments. If you want to test that a function expecting arguments throws, wrap it in another zero-argument function that calls the one you want to test.</li>
<li>A <a target="_blank" rel="noopener" href="https://api.flutter.dev/flutter/dart-async/Future-class.html">Future</a> that completes with an exception. Note that this creates an asynchronous expectation. The call to <code>expect()</code> that includes this will return immediately and execution will continue. Later, when the future completes, the actual expectation will run.</li>
<li>A <a target="_blank" rel="noopener" href="https://api.flutter.dev/flutter/dart-core/Function-class.html">Function</a> that returns a <a target="_blank" rel="noopener" href="https://api.flutter.dev/flutter/dart-async/Future-class.html">Future</a> that completes with an exception.</li>
</ul>
<p>In all three cases, when an exception is thrown, this will test that the exception object matches <code>matcher</code>. If <code>matcher</code> is not an instance of <a target="_blank" rel="noopener" href="https://api.flutter.dev/flutter/package-matcher_matcher/Matcher-class.html">Matcher</a>, it will implicitly be treated as <code>equals(matcher)</code>.</p>
</blockquote>
<p>可以看到，如果被expect的对象是一个Future对象，那么这个expect会立刻返回，而不会等待Future执行完毕。在我们这个场景下，expect的对象不是Future，而是一个返回Future的Function，但阅读throwsA的实现会发现这种情况下expect也是会立刻返回的。</p>
<p>在一般情况下，使用throwsA并没有什么问题，throwsA可以保证测试用例所在的方法执行完毕后仍然保持测试用例处于未结束的状态，等待这个expect获得结果后再结束。</p>
<p>在在这个用例中，我们expect之后马上就调用了verify检查build被调用的次数，显然此时throwsA的这个特性就会带来问题：此时build调用次数确实为1，但后一次调用还在来的路上呢。</p>
<p>查阅expect的文档：</p>
<blockquote>
<p>Certain matchers, like <a target="_blank" rel="noopener" href="https://pub.dev/documentation/test_api/latest/test_api/completion.html">completion</a> and <a target="_blank" rel="noopener" href="https://pub.dev/documentation/test_api/latest/test_api/throwsA.html">throwsA</a>, either match or fail asynchronously. When you use <a target="_blank" rel="noopener" href="https://pub.dev/documentation/test_api/latest/test_api/expect.html">expect</a> with these matchers, it ensures that the test doesn’t complete until the matcher has either matched or failed. If you want to wait for the matcher to complete before continuing the test, you can call <a target="_blank" rel="noopener" href="https://pub.dev/documentation/test_api/latest/test_api/expectLater.html">expectLater</a> instead and <code>await</code> the result.</p>
</blockquote>
<p>于是可见，我们应该把测试用例改成：</p>
<figure class="highlight dart"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-comment">// 增加async关键字，我们需要使用await</span><br>  testWithoutContext(<span class="hljs-string">&#x27;calls buildSystem.build with blank l10n.yaml file&#x27;</span>, () <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 改用expectLater，并await以保证被expect的方法已经结束并返回</span><br>    <span class="hljs-keyword">await</span> expectLater(<br>      () =&gt; generateLocalizationsSyntheticPackage(<br>        environment: environment,<br>        buildSystem: buildSystem,<br>      ),<br>      throwsToolExit(message: <span class="hljs-string">&#x27;Generating synthetic localizations package has failed.&#x27;</span>),<br>    );<br>    <span class="hljs-comment">// [BuildSystem] should have called build with [GenerateLocalizationsTarget].</span><br>    verify(buildSystem.build(<br>      <span class="hljs-keyword">const</span> GenerateLocalizationsTarget(),<br>      environment,<br>    )).called(<span class="hljs-number">1</span>);<br>  &#125;);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>这样修改之后，我们的测试用例就失败了，因此也就可以修改代码修复这个bug了。</p>
<h1 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h1><p>throwsA会导致expect异步执行，在和verify搭配使用的时候这样的错误隐蔽又致命，但似乎Flutter和Dart的文档中都没有特别提到这一点，不知道Flutter代码中还有多少这样错误的测试用例代码呢www</p>
<p>另外，明明都是自动生成代码，JSON Annotation库使用的是Build Runner，但Flutter Localization使用的却是Flutter Generate，而且从代码中可以看到这块逻辑几乎完全耦合在Flutter代码中（以至于pubspec.yaml中的<code>generate</code>似乎仅仅用于本地化这个模块），为什么不把Localization也交给Build Runner来做呢？</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/flutter/">Flutter</a>
                    
                      <a class="hover-with-bg" href="/tags/i18n/">i18n</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/04/build-leaf-android-on-windows/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">在Windows上编译Leaf Android</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/09/10/two-issues-on-android-obfuscation/">
                        <span class="hidden-mobile">Android代码混淆问题处理两则</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'https://perqin.github.io/2021/03/21/from-flutter-build-failure-to-pr/';
          this.page.identifier = '/2021/03/21/from-flutter-build-failure-to-pr/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'perqin-github-io' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
    <!-- cnzz Analytics Icon -->
    <span id="cnzz_stat_icon_1279692316" style="display: none"></span>
  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  

  

  

  

  
    <!-- cnzz Analytics -->
    <script defer src="//s4.cnzz.com/z_stat.php?id=1279692316&show=pic"
            type="text/javascript"></script>
  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
