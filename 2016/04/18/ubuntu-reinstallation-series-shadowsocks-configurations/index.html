<!DOCTYPE html><html><head><meta charset="UTF-8"><link rel="stylesheet" href="/mdl/material.min.css"><script src="/mdl/material.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.teal-pink.min.css"><link rel="stylesheet" href="/css/layout.css"><link rel="stylesheet" href="/css/post.css"><title>重装Ubuntu系列：Shadowsocks配置</title></head><body><div class="mdl-layout mdl-js-layout mdl-color--grey-50"><header class="mdl-layout__header mdl-layout--fixed-header"><div class="mdl-layout__header-row"><span class="mdl-layout-title">重装Ubuntu系列：Shadowsocks配置</span></div></header><div class="mdl-layout__drawer"><span class="mdl-layout-title">Perqin</span><nav class="mdl-navigation"><a href="/" class="mdl-navigation__link mdl-js-ripple-effect">Home</a><a href="/archive" class="mdl-navigation__link">Archive</a><a href="https://github.com/" target="_blank" class="mdl-navigation__link">GitHub</a><a href="http://weibo.com/" target="_blank" class="mdl-navigation__link">Weibo</a></nav></div><main class="mdl-layout__content"><div class="cover-layout mdl-grid"><div class="mdl-cell--bottom"><h2 class="mdl-typography--display-3">Perqin's Blog</h2><h4 class="mdl-typography--display-1">Maintaining...</h4></div></div><div class="mdl-card post-card mdl-shadow--2dp wide-card"><div class="mdl-card__title"><p class="mdl-card__title-text">重装Ubuntu系列：Shadowsocks配置</p></div><div class="mdl-card__supporting-text"><p>说实话Ubuntu（版本<code>14.04 LTS</code>）的重装成本比Windows高太多了，一方面是自己不熟悉，另一方面也不如Windows只要exe和msi就能搞定，然而搞崩Ubuntu或者改动分区之后又不得不重装（妈蛋重装系统和重搭博客是我干得最多的事！！），往往有些配置有没有记下来，于是有了写这个系列的想法。<br>作为本系列的第一蛋，自然要先把科学上网的问题解决，因为已经有了VPS，所以只需要搞定客户端的问题。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="http://www.ihunter.me/Ubuntu%2014.04%20VPS%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEShadowsocks%E7%9A%84%E6%96%B9%E6%B3%95.html" target="_blank" rel="external">Ubuntu 14.04 VPS安装配置Shadowsocks的方法</a></li>
<li><a href="https://github.com/snachx/gfwlist2privoxy" target="_blank" rel="external">snachx/gfwlist2privoxy</a></li>
<li><a href="https://github.com/gfwlist/gfwlist" target="_blank" rel="external">gfwlist/gfwlist</a></li>
<li><a href="http://askubuntu.com/questions/18802/how-to-correctly-add-a-custom-daemon-to-init-d" target="_blank" rel="external">10.04 - How to correctly add a custom daemon to init.d? - Ask Ubuntu</a></li>
</ul>
<h1 id="安装Shadowsocks-python客户端"><a href="#安装Shadowsocks-python客户端" class="headerlink" title="安装Shadowsocks-python客户端"></a>安装Shadowsocks-python客户端</h1><p>事实上编译<code>libev</code>版本的也是可行的，但是实在麻烦，这里图方便就用了python版本的实现。<br>在终端输入以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install python-gevent python-pip python-m2crypto</div><div class="line">sudo pip install shadowsocks</div></pre></td></tr></table></figure></p>
<p>至此Shadowsocks就安装好了。</p>
<h1 id="配置客户端"><a href="#配置客户端" class="headerlink" title="配置客户端"></a>配置客户端</h1><p>Shadowsocks的python版本同时安装了客户端和服务器端，分别是<code>sslocal</code>和<code>ssserver</code>。<br>在<code>/etc/shadowsocks/</code>新建一个文件<code>sslocal.json</code>（其实放哪里无所谓，但是配置文件一般放在<code>/etc</code>里面），输入以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;server&quot;:&quot;1.2.3.4&quot;,</div><div class="line">  &quot;server_port&quot;:5678,</div><div class="line">  &quot;local_port&quot;:1080,</div><div class="line">  &quot;password&quot;:&quot;passfoobar&quot;,</div><div class="line">  &quot;timeout&quot;:600,</div><div class="line">  &quot;method&quot;: &quot;aes-256-cfb&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中<code>server</code>是服务器地址，<code>server_port</code>是服务器端口，<code>local_port</code>是本地端口，一般默认就是<code>1080</code>，<code>password</code>是密码，<code>timeout</code>是超时时间（并不知道有什么用- -），<code>method</code>是加密方式，默认就是<code>aes-256-cfb</code>。</p>
<h1 id="运行Shadowsocks"><a href="#运行Shadowsocks" class="headerlink" title="运行Shadowsocks"></a>运行Shadowsocks</h1><p>在命令行输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo sslocal -c /etc/shadowsocks/sslocal.json -d start</div></pre></td></tr></table></figure></p>
<p>之后Shadowsocks就作为守护进程在后台运行了，参数c指定了配置文件，d参数要求运行守护（后台）进程。这里需要注意的是必须用sudo运行，否则会无法读取配置文件。</p>
<h1 id="安装与配置Privoxy"><a href="#安装与配置Privoxy" class="headerlink" title="安装与配置Privoxy"></a>安装与配置Privoxy</h1><p>运行了Shadowsocks之后你会发现即使给浏览器设置了代理端口，依然无法翻墙，这是因为Ubuntu 14.04本身不支持<code>socks5</code>协议，而python实现的Shadowsocks本身只有这个协议，因此在看了Windows上C#版本的Shadowsocks实现的源码之后想到了解决方法：使用Privoxy在<code>localhost:8123</code>运行一个HTTP代理，然后转发到1080端口上去，然后将浏览器的代理设置到8123端口就行啦！<br>事实上使用Privoxy还有一个好处，那就是可以依托Privoxy强大的action文件进行局部代理，Windows上是通过pac文件实现的，但是Privoxy不支持pac文件，怎么办呢？<br>庆幸的是，GitHub上有一个项目<code>gfwlist2privoxy</code>可以把GFWList文件转换成Privoxy的action文件，而GFWList是一个开源项目，收集更新被墙的域名列表。于是解决方法也出来了：从gfwlist下载最新的gfwlist文件，然后用gfwlist2privoxy转换成action文件即可！<br>废话说完，开始配置，首先下载Privoxy：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install privoxy</div></pre></td></tr></table></figure></p>
<p>完成之后在这里下载<a href="https://github.com/gfwlist/gfwlist/raw/master/gfwlist.txt" target="_blank" rel="external">最新的gfwlist.txt</a>，放到个人目录里，然后安装<code>gfwlist2privoxy</code>并生成action文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo pip install gfwlist2privoxy</div><div class="line">sudo gfwlist2privoxy -i ~/gfwlist.txt -f /etc/privoxy/gfwlist.action -p &quot;127.0.0.1:1080&quot; -t socks5</div></pre></td></tr></table></figure></p>
<p>接下来修改Privoxy的配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/privoxy/config</div></pre></td></tr></table></figure></p>
<p>首先指定监听地址：<br><img src="set-privoxy-listen-address.png" alt="Set Privoxy listen address"><br>然后增加action文件：<br><img src="add-privoxy-action-file.png" alt="Add Privoxy action file"><br>最后重启Privoxy服务，只要没有报错就大功告成！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service privoxy restart</div></pre></td></tr></table></figure></p>
<h1 id="给浏览器配置代理"><a href="#给浏览器配置代理" class="headerlink" title="给浏览器配置代理"></a>给浏览器配置代理</h1><p>火狐浏览器的设置里就可以配置，直接修改即可：<br><img src="set-proxy-for-firefox.png" alt="Set proxy for Firefox"><br>至于Chromium浏览器，是直接使用系统设置的，这里可以直接在Ubuntu的网络设置里修改，进入<code>System Settings</code> - <code>Network</code> - <code>Network proxy</code>，设置完成后点击<code>Apply to system wide</code>即可。<br><img src="set-system-proxy.png" alt="Set system proxy"><br>另一种方法是在.bashrc文件末尾加上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export http_proxy=http://localhost:8123</div><div class="line">export https_proxy=http://localhost:8123</div></pre></td></tr></table></figure></p>
<p>之后输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">. ~/.bashrc</div></pre></td></tr></table></figure></p>
<p>更新环境即可。</p>
<h1 id="让Shadowsocks开机自启动"><a href="#让Shadowsocks开机自启动" class="headerlink" title="让Shadowsocks开机自启动"></a>让Shadowsocks开机自启动</h1><p>这里一切都接近完美，但是仍然有个问题：每次开机需要手动启动Shadowsocks，能不能把Shadowsocks也变成service呢？当然可以，只需要在<code>/etc/init.d/</code>里面增加一个脚本即可。这个目录里有个<code>skeleton</code>文件，是模板文件，我已经进行了修改，虽然没有输出，但是能够正常启动，从<a href="https://gist.github.com/perqin/2867f8fac6dbbf2514b7471095233668/raw/84207cb3a4fbf702df828504b643c5b65a77c7ab/sslocal" target="_blank" rel="external">这里</a>下载这个文件到个人目录，然后更新服务列表启动服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo cp ~/sslocal /etc/init.d/sslocal</div><div class="line">sudo chmod a+x /etc/init.d/sslocal</div><div class="line">sudo update-rc.d sslocal defaults 97 03</div><div class="line">sudo service sslocal start</div></pre></td></tr></table></figure></p>
<h1 id="还不够完美"><a href="#还不够完美" class="headerlink" title="还不够完美"></a>还不够完美</h1><p>到这里我们已经能够无痛翻墙，但是还有两个问题：</p>
<ul>
<li>服务自启动脚本没有输出，不能确定运行状态；</li>
<li>无法自动更新gfwlist和更新用户规则</li>
</ul>
<p>这两个以后我会解决后另行发文记录，嘿嘿！</p>
</div><div class="mdl-card__actions"></div></div><div><!-- 多说评论框 start--><div data-thread-key="cirmbi3he0001yb1szagtixr8" data-title="重装Ubuntu系列：Shadowsocks配置" data-url="http://blog.perqin.com/2016/04/18/ubuntu-reinstallation-series-shadowsocks-configurations/" class="ds-thread"></div><!-- 多说评论框 end--></div></main></div><button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--fab mdl-button--accent back-to-top-button"><i class="material-icons">keyboard_arrow_up</i></button><!-- 多说公共JS代码 start (一个网页只需插入一次)--><script type="text/javascript">var duoshuoQuery = {short_name:"perqinblog"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script><!-- 多说公共JS代码 end--></body></html>